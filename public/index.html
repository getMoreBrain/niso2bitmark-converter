<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NISO2Bitmark Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">

</head>

<body class="font-sans h-screen flex flex-col">

    <!-- Header & Navigation -->
    <header class="shadow-sm z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center mr-8">
                        <img src="https://resources.getmorebrain.com/images/gmb-logo-n1.svg" alt="Get More Brain"
                            class="h-10">
                        <h1 class="ml-4 text-xl font-bold text-white tracking-tight">Niso2Bitmark Converter</h1>
                    </div>
                    <div class="hidden sm:flex sm:space-x-8">
                        <a href="#" onclick="switchTab('converter')" id="tab-converter"
                            class="border-primary text-white inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors duration-200">
                            Konverter
                        </a>
                        <a href="#" onclick="switchTab('archive')" id="tab-archive"
                            class="border-transparent text-gray-400 hover:text-white hover:border-gray-500 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors duration-200">
                            Archiv / Explorer
                        </a>
                    </div>
                </div>
                <!-- Language Switcher -->
                <div class="flex items-center ml-auto mr-4">
                    <select id="lang-select" onchange="changeLanguage(this.value)"
                        class="bg-[#2a2a2a] text-white border border-gray-600 rounded px-2 py-1 text-sm focus:outline-none focus:border-primary">
                        <option value="de">DE</option>
                        <option value="en">EN</option>
                        <option value="fr">FR</option>
                        <option value="it">IT</option>
                    </select>
                </div>

                <!-- Dev Mode Toggle -->
                <div class="flex items-center ml-4 mr-4">
                    <label class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="dev-mode-toggle" class="sr-only peer" onchange="toggleDevMode()">
                            <div
                                class="w-10 h-4 bg-gray-400 rounded-full shadow-inner peer-checked:bg-green-400 transition">
                            </div>
                            <div
                                class="dot absolute w-6 h-6 bg-white rounded-full shadow -left-1 -top-1 transition transform peer-checked:translate-x-full">
                            </div>
                        </div>
                        <div class="ml-3 text-white text-sm font-medium">
                            Dev Mode
                        </div>
                    </label>
                </div>

                <!-- New Upload Button -->
                <div class="flex items-center">
                    <button onclick="startNewUpload()"
                        class="bg-primary hover:bg-green-600 text-white font-bold py-2 px-4 rounded flex items-center shadow-lg transition transform hover:-translate-y-0.5 ml-4">
                        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                        <span data-i18n="btn_new_upload">New Upload</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-6" id="main-container">

        <!-- Converter Tab -->
        <section id="view-converter" class="max-w-4xl mx-auto space-y-8">

            <!-- NormID Display -->
            <!-- NormID Display -->
            <div id="normid-display"
                class="opacity-0 transition-opacity duration-1000 mb-8 flex justify-center items-center h-12">
                <span class="text-gray-400 text-sm font-medium mr-3 uppercase tracking-wider"
                    data-i18n="normid_label">Normen-Paket:</span>
                <span id="normid-value" class="text-2xl font-bold text-white tracking-tight"></span>
            </div>

            <!-- Stepper -->
            <div class="flex items-center justify-between mb-8">
                <div class="w-full flex justify-between relative">
                    <div class="step-item flex-1 relative text-center z-10" id="step-1-indicator">
                        <div
                            class="w-10 h-10 mx-auto bg-primary text-white rounded-full flex items-center justify-center font-bold">
                            1</div>
                        <div class="mt-2 text-sm font-medium text-gray-200" data-i18n="step_upload">Upload</div>
                        <div class="absolute top-5 left-1/2 w-full h-1 bg-gray-700 -z-10"></div>
                    </div>
                    <div class="step-item flex-1 relative text-center z-10" id="step-2-indicator">
                        <div
                            class="w-10 h-10 mx-auto bg-gray-700 text-gray-400 rounded-full flex items-center justify-center font-bold">
                            2</div>
                        <div class="mt-2 text-sm font-medium text-gray-400" data-i18n="step_check">Prüfung</div>
                        <div class="absolute top-5 left-1/2 w-full h-1 bg-gray-700 -z-10"></div>
                    </div>
                    <div class="step-item flex-1 relative text-center z-10" id="step-3-indicator">
                        <div
                            class="w-10 h-10 mx-auto bg-gray-700 text-gray-400 rounded-full flex items-center justify-center font-bold">
                            3</div>
                        <div class="mt-2 text-sm font-medium text-gray-400" data-i18n="step_transform">Transform</div>
                        <div class="absolute top-5 left-1/2 w-full h-1 bg-gray-700 -z-10"></div>
                    </div>
                    <div class="step-item flex-1 relative text-center z-10" id="step-4-indicator">
                        <div
                            class="w-10 h-10 mx-auto bg-gray-700 text-gray-400 rounded-full flex items-center justify-center font-bold">
                            4</div>
                        <div class="mt-2 text-sm font-medium text-gray-400" data-i18n="step_consistency">
                            Konsistenzprüfung</div>
                        <div class="absolute top-5 left-1/2 w-full h-1 bg-gray-700 -z-10"></div>
                    </div>
                    <div class="step-item flex-1 relative text-center z-10" id="step-5-indicator">
                        <div
                            class="w-10 h-10 mx-auto bg-gray-700 text-gray-400 rounded-full flex items-center justify-center font-bold">
                            5</div>
                        <div class="mt-2 text-sm font-medium text-gray-400" data-i18n="step_release">Release</div>
                    </div>
                </div>
            </div>

            <!-- Steps Content -->
            <div class="bg-[#1f1f1f] shadow-lg rounded-lg p-8 min-h-[400px] border border-gray-800">

                <!-- Step 1: Upload -->
                <div id="step-1" class="step-content">
                    <h2 class="text-2xl font-semibold mb-6 text-white" data-i18n="upload_title">Normen-ZIP hochladen
                    </h2>
                    <div id="drop-zone"
                        class="border-2 border-dashed border-gray-600 rounded-lg p-12 text-center hover:border-primary transition cursor-pointer bg-[#2a2a2a] hover:bg-[#333]">
                        <div class="space-y-4">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                viewBox="0 0 48 48" aria-hidden="true">
                                <path
                                    d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="text-sm text-gray-400">
                                <span class="font-medium text-primary" data-i18n="upload_drag">Datei auswählen</span>
                                <span data-i18n="upload_drag_suffix">oder hierher ziehen</span>
                            </div>
                            <p class="text-xs text-gray-500" data-i18n="upload_hint">ZIP Dateien (<NormID>_....zip)</p>
                        </div>
                        <input id="file-upload" type="file" class="hidden" accept=".zip" />
                    </div>
                    <div id="upload-progress" class="hidden my-12 text-center">
                        <div class="flex justify-center mb-4">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                        </div>
                        <p class="text-gray-300">Upload in progress...</p>
                    </div>
                    <div id="upload-status" class="mt-4 text-center hidden"></div>
                </div>

                <!-- Step 2: Content Check -->
                <div id="step-2" class="step-content hidden text-center">
                    <h2 class="text-2xl font-semibold mb-6 text-white" data-i18n="check_title">Inhaltsprüfung</h2>
                    <div id="check-progress" class="hidden">
                        <div class="flex justify-center mb-4">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                        </div>
                        <p class="text-gray-300" data-i18n="check_progress">Prüfe Inhalt...</p>
                    </div>
                </div>

                <!-- Step 3: Transform (formerly 2) -->
                <div id="step-3" class="step-content hidden text-center">
                    <h2 class="text-2xl font-semibold mb-6 text-white" data-i18n="transform_title">Transformation</h2>
                    <div id="transform-idle">
                        <button onclick="startTransformation()"
                            class="bg-primary hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-1"
                            data-i18n="btn_start_transform">
                            Start Transformation
                        </button>
                    </div>
                    <div id="transform-progress" class="hidden max-w-md mx-auto mt-8 space-y-4">
                        <div class="relative pt-1">
                            <div class="overflow-hidden h-4 mb-4 text-xs flex rounded bg-blue-100">
                                <div id="progress-bar" style="width:0%"
                                    class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-primary transition-all duration-500">
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-sm font-medium mt-2">
                            <span id="progress-text" class="text-gray-600 animate-pulse">Initializing...</span>
                            <span id="current-book" class="text-primary font-bold"></span>
                        </div>
                        <!-- Morphing Icon Animation Placeholder Removed -->
                    </div>
                </div>
                <!-- Step 4: Consistency Check -->
                <!-- Step 4: Consistency Check -->
                <div id="step-4" class="step-content hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-white" data-i18n="consistency_title">Konsistenzprüfung
                    </h2>

                    <!-- Header / Stats -->
                    <div id="report-stats"
                        class="flex items-center space-x-6 mb-6 p-4 bg-[#2a2a2a] rounded border border-gray-700">
                        <!-- Populated by JS -->
                        <div class="text-gray-400">Lade Bericht...</div>
                    </div>

                    <!-- Report List -->
                    <div id="report-list" class="space-y-4 mb-8 max-h-[500px] overflow-y-auto pr-2">
                        <!-- Populated by JS -->
                    </div>

                    <div class="mt-6 flex justify-end space-x-4">
                        <button id="btn-download-csv" onclick="downloadCSV()"
                            class="hidden bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded flex items-center shadow-lg transition transform hover:-translate-y-0.5"
                            title="Download Findings as CSV">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            <span data-i18n="btn_download_findings">Download Findings</span>
                        </button>
                        <button id="btn-download-bitmark" onclick="downloadBitmark()"
                            class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded flex items-center shadow-lg transition transform hover:-translate-y-0.5">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            <span data-i18n="btn_download_bitmark">Download .bitmark</span>
                        </button>
                        <button id="btn-next-step" onclick="goToStep(5)"
                            class="bg-primary hover:bg-blue-700 text-white font-bold py-2 px-6 rounded disabled:opacity-50 disabled:cursor-not-allowed"
                            data-i18n="btn_next">Weiter</button>
                    </div>
                </div>

                <!-- Step 5: Release (formerly 4) -->
                <div id="step-5" class="step-content hidden">
                    <div class="max-w-md mx-auto">
                        <h2 class="text-2xl font-semibold mb-6 text-center text-white" data-i18n="release_title">Release
                            bestätigen</h2>
                        <form id="release-form" onsubmit="handleRelease(event)">
                            <div class="mb-4">
                                <label class="block text-gray-300 text-sm font-bold mb-2" for="release-note"
                                    data-i18n="lbl_release_note">
                                    Kurzbeschreibung / Release Note
                                </label>
                                <textarea id="release-note"
                                    class="gmb-input shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"
                                    rows="3" placeholder="Was hat sich geändert?"
                                    oninput="checkReleaseForm()"></textarea>
                                <p class="text-right text-xs text-gray-500"><span id="char-count">0</span>/15 Zeichen
                                </p>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-300 text-sm font-bold mb-2" for="release-name"
                                    data-i18n="lbl_release_name">
                                    Name des Releasers
                                </label>
                                <input id="release-name" type="text"
                                    class="gmb-input shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"
                                    placeholder="Ihr Name" oninput="checkReleaseForm()">
                            </div>
                            <!-- Checkbox removed -->
                            <div class="flex items-center justify-between">
                                <button type="button" onclick="goToStep(1); resetState();"
                                    class="text-gray-400 hover:text-white font-bold py-2 px-4 rounded"
                                    data-i18n="btn_cancel">
                                    Abbrechen
                                </button>
                                <button type="submit" id="btn-release"
                                    class="bg-gray-600 text-white font-bold py-2 px-6 rounded cursor-not-allowed"
                                    disabled data-i18n="btn_publish">
                                    Veröffentlichen
                                </button>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </section>

        <!-- Archive Tab -->
        <section id="view-archive" class="max-w-6xl mx-auto hidden space-y-6">
            <h2 class="text-2xl font-bold text-white">Versionshistorie</h2>

            <div class="flex justify-between items-center bg-[#1f1f1f] p-4 rounded shadow border border-gray-800">
                <input type="text" id="files-search" placeholder="Suche..."
                    class="gmb-input border rounded px-4 py-2 w-64 text-white" oninput="filterVersions()">
                <button onclick="loadVersions()" class="text-primary hover:text-green-400">Aktualisieren</button>
            </div>

            <div class="bg-[#1f1f1f] shadow overflow-hidden sm:rounded-md border border-gray-800">
                <table class="min-w-full divide-y divide-gray-800">
                    <thead class="bg-gray-900">
                        <tr>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                Status</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                Norm ID / Version</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                Release Note</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                Datum</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                Aktion</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800" id="versions-list">
                        <!-- Rows populated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <!-- Notification Toast -->
    <div id="toast"
        class="fixed bottom-5 right-5 px-6 py-4 rounded shadow-lg text-white transform transition-all duration-300 translate-y-20 opacity-0 hidden z-50">
        Message
    </div>

    <!-- Logic -->
    <script>
        // State
        let currentStep = 1;
        let sessionData = {
            sessionID: null,
            filename: null,
            normID: null
        };
        let socket;
        let i18n = {};
        let currentLang = 'en';
        let isDevMode = false;

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Detect Lang
            // 1. Detect Lang
            const browserLang = (navigator.language || navigator.userLanguage).substring(0, 2);
            const supported = ['de', 'en', 'fr', 'it'];
            currentLang = supported.includes(browserLang) ? browserLang : 'en';

            // Set Dropdown
            const langSelect = document.getElementById('lang-select');
            if (langSelect) langSelect.value = currentLang;

            // 2. Load Messages
            try {
                const res = await fetch('api/messages');
                i18n = await res.json();
                applyTranslations();
            } catch (e) { console.error("I18n load failed"); }

            setupDragAndDrop();
            connectWebSocket();
            loadVersions(); // Preload
        });

        function t(key, params = {}) {
            let text = '';
            // Check flat key first (from legacy if any) or nested 'ui'/'errors'/'infos'
            if (i18n.ui && i18n.ui[key]) text = i18n.ui[key][currentLang];
            else if (i18n.errors && i18n.errors[key]) text = i18n.errors[key][currentLang];
            else if (i18n.infos && i18n.infos[key]) text = i18n.infos[key][currentLang];
            else text = key; // Fallback

            // Params replacement
            Object.keys(params).forEach(k => {
                text = text.replace(`{${k}}`, params[k]);
            });
            return text;
        }

        function changeLanguage(lang) {
            currentLang = lang;
            applyTranslations();
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key) el.innerText = t(key);
            });
            // Placeholders
            if (document.getElementById('files-search')) document.getElementById('files-search').placeholder = t('search_placeholder');
            if (document.getElementById('release-name')) document.getElementById('release-name').placeholder = t('ph_release_name');
            if (document.getElementById('release-note')) document.getElementById('release-note').placeholder = t('ph_release_note');
        }

        // Navigation
        function switchTab(tab) {
            document.getElementById('view-converter').classList.add('hidden');
            document.getElementById('view-archive').classList.add('hidden');
            document.getElementById('tab-converter').classList.replace('border-primary', 'border-transparent');
            document.getElementById('tab-archive').classList.replace('border-primary', 'border-transparent');
            document.getElementById('tab-converter').classList.remove('text-gray-900');
            document.getElementById('tab-archive').classList.remove('text-gray-900');

            if (tab === 'converter') {
                document.getElementById('view-converter').classList.remove('hidden');
                document.getElementById('tab-converter').classList.replace('border-transparent', 'border-primary');
                document.getElementById('tab-converter').classList.replace('text-gray-400', 'text-white');
            } else {
                document.getElementById('view-archive').classList.remove('hidden');
                document.getElementById('tab-archive').classList.replace('border-transparent', 'border-primary');
                document.getElementById('tab-archive').classList.replace('text-gray-400', 'text-white');
                loadVersions();
            }
        }

        // Stepper Logic
        function goToStep(step) {
            if (isDevMode && step === 5) {
                // Block release step in dev mode
                return;
            }

            // Hide all contents
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            // Show target
            document.getElementById(`step-${step}`).classList.remove('hidden');

            // Update indicators
            for (let i = 1; i <= 5; i++) {
                const indicator = document.getElementById(`step-${i}-indicator`).querySelector('div');
                const indicatorContainer = document.getElementById(`step-${i}-indicator`);

                // Hide Release Step in Dev Mode completely or just disable? 
                // Requirement: "nicht möglich einen Release durchzuführen" & "UI soll slider-schalter ... angezeigt werden"
                // Let's grey it out visually in Dev Mode or keep it but block access.
                // Better: keep it visible but disabled/blocked.

                if (i <= step) {
                    indicator.classList.remove('bg-gray-700', 'text-gray-400');
                    indicator.classList.add('bg-primary', 'text-white');
                } else {
                    indicator.classList.remove('bg-primary', 'text-white');
                    indicator.classList.add('bg-gray-700', 'text-gray-400');
                }
            }
            currentStep = step;

            // If entering Consistency Check, load report
            if (step === 4) {
                loadConsistencyReport();
            }
        }

        function toggleDevMode() {
            const toggle = document.getElementById('dev-mode-toggle');
            isDevMode = toggle.checked;
            console.log("DevMode:", isDevMode);

            const btnNext = document.getElementById('btn-next-step');
            const btnDownload = document.getElementById('btn-download-bitmark');
            const step5Ind = document.getElementById('step-5-indicator');

            if (isDevMode) {
                // Logic for Dev Mode ON
                if (btnNext) btnNext.classList.add('hidden');
                if (btnDownload) btnDownload.classList.remove('hidden');
                if (step5Ind) step5Ind.classList.add('opacity-50', 'cursor-not-allowed');
                // If we are on step 5, go back to 4?
                if (currentStep === 5) goToStep(4);
            } else {
                // Logic for Dev Mode OFF
                if (btnNext) btnNext.classList.remove('hidden');
                if (btnDownload) btnDownload.classList.add('hidden');
                if (step5Ind) step5Ind.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function downloadBitmark() {
            if (!sessionData.sessionID || !sessionData.normID) {
                showToast("Keine Session Daten vorhanden", "error");
                return;
            }
            // Use standard window location to trigger download
            window.location.href = `api/download-session/${sessionData.sessionID}/${sessionData.normID}`;
        }

        function downloadCSV() {
            if (!sessionData.sessionID || !sessionData.normID) {
                showToast("Keine Session Daten vorhanden", "error");
                return;
            }
            window.location.href = `api/consistency-report/${sessionData.sessionID}/${sessionData.normID}/csv`;
        }

        function resetState() {
            sessionData = { sessionID: null, filename: null, normID: null };

            // Step 1: Upload
            document.getElementById('upload-status').innerHTML = '';
            document.getElementById('upload-status').classList.add('hidden');
            document.getElementById('upload-progress').classList.add('hidden');

            // Step 2: Content Check
            const checkProgress = document.getElementById('check-progress');
            checkProgress.classList.add('hidden');
            // Reset to spinner
            checkProgress.innerHTML = `
                <div class="flex justify-center mb-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                </div>
                <p class="text-gray-300" data-i18n="check_progress">${t('check_progress')}</p>
            `;

            // Step 3: Transform
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('current-book').innerText = '';
            document.getElementById('transform-idle').classList.remove('hidden');
            document.getElementById('transform-progress').classList.add('hidden');
            const progressText = document.getElementById('progress-text');
            progressText.innerText = 'Initializing...';
            progressText.classList.add('animate-pulse');

            // Step 4: Consistency Check
            document.getElementById('report-stats').innerHTML = '<div class="text-gray-400">Lade Bericht...</div>';
            document.getElementById('report-list').innerHTML = '';
            document.getElementById('btn-download-csv').classList.add('hidden');
            document.getElementById('btn-download-bitmark').classList.add('hidden');

            const btnNext = document.getElementById('btn-next-step');
            if (btnNext) {
                btnNext.disabled = false;
                btnNext.classList.remove('opacity-50', 'cursor-not-allowed');
                btnNext.title = "";
            }

            // Step 5: Release
            document.getElementById('release-note').value = '';
            document.getElementById('release-name').value = '';
            // document.getElementById('release-confirm').checked = false;

            // Hide NormID Display
            document.getElementById('normid-display').classList.add('opacity-0');
            document.getElementById('normid-value').innerText = '';
        }

        // Load Consistency Report Logic
        async function loadConsistencyReport() {
            const statsDiv = document.getElementById('report-stats');
            const listDiv = document.getElementById('report-list');
            const btnNext = document.getElementById('btn-next-step');

            statsDiv.innerHTML = '<div class="text-gray-400 animate-pulse">Loading report...</div>';
            listDiv.innerHTML = '';
            btnNext.disabled = true; // Block by default until loaded and checked

            try {
                const res = await fetch(`api/consistency-report/${sessionData.sessionID}`);
                const logs = await res.json();

                // Sort: Severity DESC (3=Error, 2=Warn, 1=Info), then Category ASC, then Key ASC
                logs.sort((a, b) => {
                    if (b.severity !== a.severity) return b.severity - a.severity;
                    if (a.category !== b.category) return a.category - b.category;
                    return (a.errorMsg || "").localeCompare(b.errorMsg || "");
                });

                // Counts
                // Counts
                const errorCount = logs.filter(l => l.severity === 3).length;
                const warnCount = logs.filter(l => l.severity === 2).length;
                const infoCount = logs.filter(l => l.severity === 1).length;

                // Render Stats
                statsDiv.innerHTML = `
                    <div class="flex items-center mr-6">
                        <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                        <span class="text-white font-bold mr-1">${errorCount}</span>
                        <span class="text-gray-400 text-sm">Errors</span>
                    </div>
                    <div class="flex items-center mr-6">
                        <div class="w-3 h-3 rounded-full bg-yellow-500 mr-2"></div>
                        <span class="text-white font-bold mr-1">${warnCount}</span>
                        <span class="text-gray-400 text-sm">Warnings</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                        <span class="text-white font-bold mr-1">${infoCount}</span>
                        <span class="text-gray-400 text-sm">Infos</span>
                    </div>
                `;

                // Logic: Block if Errors > 0
                if (errorCount > 0) {
                    btnNext.disabled = true;
                    btnNext.classList.add('opacity-50', 'cursor-not-allowed');
                    btnNext.title = "Please fix all errors before release.";
                } else {
                    btnNext.disabled = false;
                    btnNext.classList.remove('opacity-50', 'cursor-not-allowed');
                    btnNext.title = "";
                }

                // Always allow download bitmark in step 4
                document.getElementById('btn-download-bitmark').classList.remove('hidden');
                document.getElementById('btn-download-csv').classList.remove('hidden');

                if (logs.length === 0) {
                    listDiv.innerHTML = '<div class="text-center text-gray-500 py-8">No issues found. ✅</div>';
                    return;
                }

                // Render Table Header
                let tableHtml = `
                    <div class="overflow-x-auto">
                    <table class="min-w-[1000px] divide-y divide-gray-700 text-sm table-fixed">
                        <thead class="bg-[#1f1f1f] sticky top-0 z-10">
                            <tr>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-10">Severity</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-15">Category</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-[20%]">Message</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider w-[80%]">Reference</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700 bg-[#1f1f1f]">
                `;

                // Render Rows
                logs.forEach(log => {
                    let colorClass = 'text-gray-400';
                    let severityIcon = '';

                    if (log.severity === 3) { // Error
                        colorClass = 'text-red-400';
                        severityIcon = '<div class="flex items-center text-red-500"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Err</div>';
                    } else if (log.severity === 2) { // Warn
                        colorClass = 'text-yellow-400';
                        severityIcon = '<div class="flex items-center text-yellow-500"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg> Warn</div>';
                    } else {
                        // Info (1)
                        colorClass = 'text-blue-400';
                        severityIcon = '<div class="flex items-center text-blue-500"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Info</div>';
                    }

                    let categoryLabel = 'General';
                    if (log.category === 1) categoryLabel = 'Link';
                    else if (log.category === 2) categoryLabel = 'XML-Structure';
                    else if (log.category === 3) categoryLabel = 'Content';

                    const msg = t(log.errorMsg, log.reference || {});
                    const refInfo = log.reference || '-';

                    tableHtml += `
                        <tr class="hover:bg-[#252525] transition-colors group">
                            <td class="px-3 py-1 whitespace-nowrap text-xs font-semibold">${severityIcon}</td>
                            <td class="px-3 py-1 whitespace-nowrap text-xs text-gray-500 uppercase tracking-wide border-r border-gray-800">${categoryLabel}</td>
                            <td class="px-3 py-1 text-xs ${colorClass} break-words whitespace-normal border-r border-gray-800">${msg}</td>
                            <td class="px-3 py-1 text-xs text-gray-400 font-mono break-all whitespace-normal">${refInfo}</td>
                        </tr>
                    `;
                });

                tableHtml += `</tbody></table></div>`;
                listDiv.innerHTML = tableHtml;

            } catch (e) {
                console.error("Error loading report:", e);
                statsDiv.innerHTML = '<div class="text-red-500">Error loading report.</div>';
            }
        }

        // Step 1: Upload
        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-upload');

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-primary', 'bg-blue-50');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-primary', 'bg-blue-50');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-primary', 'bg-blue-50');
                if (e.dataTransfer.files.length) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }

        async function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);

            const statusDiv = document.getElementById('upload-status');
            const dropZone = document.getElementById('drop-zone');
            const uploadProgress = document.getElementById('upload-progress');

            // Lock UI
            dropZone.classList.add('hidden');
            statusDiv.classList.add('hidden');
            uploadProgress.classList.remove('hidden');

            // Reset partial state for new session (keep current view until success)
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('current-book').innerText = '';
            // document.getElementById('preview-code').innerText = ''; // Removed
            document.getElementById('transform-idle').classList.remove('hidden');
            document.getElementById('transform-progress').classList.add('hidden');

            // document.body.style.cursor = 'wait'; // NEW: Wait cursor

            try {
                const res = await fetch('api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                console.log("Message: " + JSON.stringify(data));

                if (res.ok) {
                    sessionData = {
                        sessionID: data.sessionID,
                        filename: data.filename,
                        normID: null // Unknown yet
                    };

                    statusDiv.innerHTML = `<div class="text-green-600 font-bold">✅ ${file.name}</div>`;
                    showToast(t('upload_success'), 'success');

                    // Auto-start check content
                    setTimeout(() => {
                        goToStep(2);
                        checkContent();
                        // Hide bitmark download from step 4 initially (clean slate)
                        document.getElementById('btn-download-bitmark').classList.add('hidden');
                    }, 500);

                } else {
                    let errorHtml = `<div class="text-red-500 font-bold mb-2">❌ ${t('error_prefix')} ${data.message}</div>`;
                    if (data.validIDs && Array.isArray(data.validIDs)) {
                        errorHtml += `<div class="text-left mt-4 border border-gray-700 rounded p-4 bg-[#1f1f1f]"><p class="text-sm font-semibold mb-2 text-gray-300">${t('valid_ids')}</p><div class="grid grid-cols-5 gap-2 text-xs text-gray-400 max-h-64 overflow-y-auto">`;
                        data.validIDs.forEach(id => {
                            errorHtml += `<div class="bg-gray-800 p-2 rounded border border-gray-700 truncate hover:text-white" title="${id}">${id}</div>`;
                        });
                        errorHtml += '</div></div>';
                    }
                    statusDiv.innerHTML = errorHtml;
                    showToast(data.message + (data.validIDs ? " (Details)" : ""), 'error');
                }
            } catch (e) {
                statusDiv.innerHTML = `<div class="text-red-600 font-bold">❌ ${t('unexpected_error')} ${e.message}</div>`;
                console.error(e)
            } finally {
                // document.body.style.cursor = 'default'; // Reset cursor
                // Restore UI
                document.getElementById('drop-zone').classList.remove('hidden');
                document.getElementById('upload-progress').classList.add('hidden');
                document.getElementById('upload-status').classList.remove('hidden');
            }
        }

        // Step 2: Content Check
        async function checkContent() {
            const progressDiv = document.getElementById('check-progress');

            // Reset to spinner immediately to prevent flash of old error
            progressDiv.innerHTML = `
                <div class="flex justify-center mb-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                </div>
                <p class="text-gray-300" data-i18n="check_progress">${t('check_progress')}</p>
            `;

            progressDiv.classList.remove('hidden');

            try {
                const res = await fetch('api/check-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionID: sessionData.sessionID,
                        filename: sessionData.filename,
                        normID: "__UNKNOWN__" // Server validation will find it
                    })
                });

                const data = await res.json();
                console.log("Message: " + JSON.stringify(data));

                if (res.ok) {
                    // Update NormID from server
                    sessionData.normID = data.normID;
                    document.getElementById('normid-value').innerText = data.normID;
                    document.getElementById('normid-display').classList.remove('opacity-0');

                    showToast(t('check_success'), 'success');
                    setTimeout(() => goToStep(3), 1000);
                } else {
                    let msg = data.message;
                    if (data.messageKey) {
                        msg = t(data.messageKey, data.params || {});
                        msg = msg + ":\n" + data.message
                    }

                    let errorHtml = `<div class="text-red-500 font-bold mb-4">❌ ${msg}</div>`;

                    // Render Valid IDs if present (e.g. zip_error_normid_mismatch)
                    if (data.validIDs && Array.isArray(data.validIDs)) {
                        errorHtml += `<div class="text-left mt-4 border border-gray-700 rounded p-4 bg-[#1f1f1f]">
                            <p class="text-sm font-semibold mb-2 text-gray-300">${t('valid_ids')}</p>
                            <div class="grid grid-cols-5 gap-2 text-xs text-gray-400 max-h-64 overflow-y-auto">`;
                        data.validIDs.forEach(id => {
                            errorHtml += `<div class="bg-gray-800 p-2 rounded border border-gray-700 truncate hover:text-white transition-colors duration-150" title="${id}">${id}</div>`;
                        });
                        errorHtml += '</div></div>';
                    }

                    progressDiv.innerHTML = errorHtml;
                    showToast(msg, 'error');
                }

            } catch (e) {
                showToast(t('network_error' + (e.message ? ': ' + e.message : '')), 'error');
                console.error(e);
            }
        }

        // Step 3: Transform (formerly 2)
        async function startTransformation() {
            document.getElementById('transform-idle').classList.add('hidden');
            document.getElementById('transform-progress').classList.remove('hidden');

            try {
                const res = await fetch('api/transform', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sessionData)
                });

                if (res.status === 409) {
                    const data = await res.json();
                    showToast('⚠️ Das System ist gerade beschäftigt. Bitte warten Sie, bis die aktuelle Transformation abgeschlossen ist.', 'error');
                    // Reset UI
                    document.getElementById('transform-idle').classList.remove('hidden');
                    document.getElementById('transform-progress').classList.add('hidden');
                    return;
                }

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.message);
                }
            } catch (e) {
                showToast('Fehler beim Starten der Transformation: ' + e.message, 'error');
                document.getElementById('transform-idle').classList.remove('hidden');
                document.getElementById('transform-progress').classList.add('hidden');
            }
        }

        function startNewUpload() {
            if (confirm(t('confirm_new_upload'))) {
                resetState();
                switchTab('converter');
                goToStep(1);
            }
        }

        // WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Construct path based on current location to support proxies/subpaths
            // If we are at /x-publisher/, we want ws://host/x-publisher/
            // Note: Server accepts upgrade on any path or we assume it matches http path context
            let path = window.location.pathname;
            if (!path.endsWith('/')) {
                path = path.substring(0, path.lastIndexOf('/') + 1);
            }
            // Use 'api/ws' relative path
            const wsUrl = `${protocol}//${window.location.host}${path}api/ws`;
            console.log("Connecting to WebSocket:", wsUrl);
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log('WebSocket connected');
                // showToast('WS Connected', 'success'); // Optional, maybe too noisy
            };

            socket.onerror = (e) => {
                console.error('WebSocket Error:', e);
                // Try to reconnect or warn?
                showToast('Verbindung (WS) unterbrochen', 'error');
            };

            socket.onclose = (e) => {
                console.log('WebSocket Closed:', e.code, e.reason);
                if (!e.wasClean) {
                    showToast('Verbindung zum Server (WS) verloren. Bitte Seite neu laden.', 'error');
                }
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'STATUS') {
                    const bar = document.getElementById('progress-bar');
                    const text = document.getElementById('progress-text');

                    bar.style.width = data.progress + '%';

                    // NEW: Handle localized messageKey
                    let displayMsg = data.message;
                    if (data.messageKey) {
                        displayMsg = t(data.messageKey, data.params || {});
                    }
                    text.innerText = displayMsg;

                    if (data.normID) {
                        document.getElementById('current-book').innerText = "Buch: " + data.normID;
                    }

                    if (data.completed) {
                        setTimeout(() => {
                            showToast(t('check_success'), 'success'); // Reuse success msg or new one 'Transformation Done'
                            // loadPreview(); // Preview removed
                            goToStep(4);
                        }, 500);
                    }
                } else if (data.type === 'ERROR') {
                    // Also attempt translation for errors if key provided (though server usually sends msg string)
                    let errorMsg = data.message;
                    if (data.messageKey) {
                        errorMsg = t(data.messageKey, data.params || {});
                    }
                    showToast('Transformation fehlgeschlagen: ' + errorMsg, 'error');
                }
            };
        }

        /* 
        // Preview functions removed
        // Step 3: Preview
        async function loadPreview() {
             ...
        }
 
        function downloadPreview() {
             ...
        } 
        */

        // Step 4: Release
        function checkReleaseForm() {
            const note = document.getElementById('release-note').value;
            const name = document.getElementById('release-name').value;
            // const confirm = document.getElementById('release-confirm').checked;
            const count = note.length;
            const countEl = document.getElementById('char-count');
            const btn = document.getElementById('btn-release');

            countEl.innerText = count;
            countEl.style.color = count < 15 ? 'red' : 'green';

            // Changed: Removed confirm check
            if (count >= 15 && name.trim().length > 0) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-accent', 'hover:bg-green-600');
            } else {
                btn.disabled = true;
                btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                btn.classList.remove('bg-accent', 'hover:bg-green-600');
            }
        }

        async function handleRelease(e) {
            e.preventDefault();
            const note = document.getElementById('release-note').value;
            const name = document.getElementById('release-name').value;
            // const confirm = document.getElementById('release-confirm').checked;

            try {
                const res = await fetch('api/release', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionID: sessionData.sessionID,
                        releaseNote: note,
                        releaseName: name,
                        label: ''
                        // confirm: confirm // Removed
                    })
                });

                if (res.ok) {
                    showToast('Version erfolgreich veröffentlicht!', 'success');
                    switchTab('archive');
                    resetState();
                    goToStep(1);
                } else {
                    const data = await res.json();
                    showToast('Fehler: ' + data.message, 'error');
                }
            } catch (err) {
                showToast('Verbindungsfehler', 'error');
            }
        }

        // Archive
        let versionsCache = [];

        async function loadVersions() {
            try {
                const res = await fetch('api/versions');
                versionsCache = await res.json();
                renderVersions(versionsCache);
            } catch (e) {
                console.error(e);
            }
        }

        function renderVersions(list) {
            const tbody = document.getElementById('versions-list');
            tbody.innerHTML = '';

            list.forEach(ver => {
                // Parse Meta
                let label = '';
                let note = '';
                let date = '';
                let releaser = '';

                if (ver.meta) {
                    const lines = ver.meta.split('\n');
                    lines.forEach(line => {
                        if (line.startsWith('Timestamp:')) date = line.replace('Timestamp:', '').trim();
                        if (line.startsWith('Label:')) label = line.replace('Label:', '').trim();
                        if (line.startsWith('ReleaseNote:')) note = line.replace('ReleaseNote:', '').trim();
                        if (line.startsWith('Releaser:')) releaser = line.replace('Releaser:', '').trim();
                    });
                } else {
                    date = ver.id.replace('version_', '');
                }

                // Format display date
                try {
                    const d = new Date(date);
                    if (!isNaN(d.getTime())) date = d.toLocaleString('de-CH');
                } catch (e) { }

                // Main Row
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-800', 'transition-colors', 'cursor-pointer', 'border-b', 'border-gray-800');
                tr.onclick = (e) => {
                    // Prevent toggle when clicking specific buttons/links
                    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;
                    toggleVersion(ver.id);
                };

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <svg id="icon-${ver.id}" class="w-5 h-5 text-gray-500 transform transition-transform mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${ver.type === 'current' ? 'bg-green-900 text-green-200' : 'bg-gray-700 text-gray-300'}">
                                ${ver.type === 'current' ? 'Live' : 'Archiv'}
                            </span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200 font-medium">
                        ${ver.id}
                        ${label ? `<div class="text-xs text-gray-500">${label}</div>` : ''}
                        ${releaser ? `<div class="text-xs text-gray-500">von ${releaser}</div>` : ''}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-400 max-w-xs truncate" title="${note}">
                        ${note}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${date}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-left text-sm font-medium">
                         <div class="flex items-center justify-start space-x-4">
                            <a href="api/download/${ver.id}" class="text-primary hover:text-green-300 text-sm font-bold flex items-center" title="${t('download')} (Full)" onclick="event.stopPropagation()">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                ZIP (All)
                            </a>
                            ${ver.type !== 'current' ? `
                                <button onclick="handleRollback('${ver.id}'); event.stopPropagation();" class="text-red-400 hover:text-red-300" title="${t('rollback')}">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);

                // Details Row
                const trDetails = document.createElement('tr');
                trDetails.id = `details-${ver.id}`;
                trDetails.classList.add('hidden', 'bg-[#1a1a1a]');

                let booksHtml = '';
                if (ver.books && ver.books.length > 0) {
                    booksHtml = `<div class="grid grid-cols-7 gap-2 p-3">`;
                    ver.books.forEach(book => {
                        booksHtml += `
                            <a href="api/download/${ver.id}/${book}" target="_blank" class="block p-2 bg-[#2a2a2a] rounded hover:bg-[#333] border border-gray-700 hover:border-primary transition group text-center" title="${t('download')} ${book}">
                                <div class="flex justify-center mb-1">
                                     <svg class="w-6 h-6 text-gray-500 group-hover:text-primary transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                </div>
                                <div class="text-xs text-gray-300 font-medium truncate">${book}</div>
                            </a>
                        `;
                    });
                    booksHtml += `</div>`;
                } else {
                    booksHtml = `<div class="p-4 text-sm text-gray-500 italic text-center">Keine Bitmark-Dateien in dieser Version.</div>`;
                }

                trDetails.innerHTML = `
                    <td colspan="5" class="p-0 border-b border-gray-800 shadow-inner">
                        ${booksHtml}
                    </td>
                `;
                tbody.appendChild(trDetails);
            });
        }

        function toggleVersion(id) {
            const details = document.getElementById(`details-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                icon.classList.add('rotate-90');
            } else {
                details.classList.add('hidden');
                icon.classList.remove('rotate-90');
            }
        }

        async function handleRollback(id) {
            if (!confirm(`Möchten Sie wirklich auf Version ${id} zurückrollen? Alle neueren Versionen werden archiviert (invalidiert).`)) {
                return;
            }

            try {
                const res = await fetch('api/rollback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetVersionId: id })
                });

                const data = await res.json();

                if (res.ok) {
                    showToast('Rollback erfolgreich!', 'success');
                    loadVersions();
                } else {
                    showToast('Fehler: ' + data.message, 'error');
                }
            } catch (e) {
                showToast('Verbindungsfehler', 'error');
            }
        }

        function filterVersions() {
            const query = document.getElementById('files-search').value.toLowerCase();
            const filtered = versionsCache.filter(v =>
                v.id.toLowerCase().includes(query) ||
                (v.meta && v.meta.toLowerCase().includes(query))
            );
            renderVersions(filtered);
        }

        // Toast Helper
        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('hidden', 'translate-y-20', 'opacity-0', 'bg-red-500', 'bg-green-500', 'bg-gray-800');

            if (type === 'error') toast.classList.add('bg-red-500');
            else if (type === 'success') toast.classList.add('bg-green-500');
            else toast.classList.add('bg-gray-800');

            // Slide in
            setTimeout(() => toast.classList.remove('translate-y-20', 'opacity-0'), 10);

            // Hide after 3s
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

    </script>
</body>

</html>